---
image: registry.gitlab.com/amalchuk/docker-poetry:1.1.4-py3.9

stages:
  - testing
  - building
  - publishing

code quality:
  stage: testing
  script:
    - make install
    - make isort mypy
    - make coverage
  artifacts:
    paths:
      - htmlcov
    expire_in: 3 days

build images:
  image: docker/compose:1.27.4
  services:
    - docker:18.09.7-dind
  stage: building
  dependencies: []
  variables:
    DJANGO_SETTINGS_MODULE: readable.settings.development
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login --username $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker-compose build --compress --force-rm --pull
    - docker-compose push
  only:
    - master

deployment:
  image:
    name: docker/compose:1.27.4
    entrypoint:
      - /bin/sh
      - -c
  stage: publishing
  dependencies: []
  variables:
    DOCKER_TLS_VERIFY: 1
    DJANGO_SETTINGS_MODULE: readable.settings.production
  script: deployment/docker-publishing
  environment:
    name: production
    url: https://readable.pw
  only:
    - master

pages:
  stage: publishing
  dependencies:
    - code quality
  script:
    - rm --force --recursive public
    - cp --recursive htmlcov public
  environment:
    name: coverage
    url: https://coverage.readable.pw
  artifacts:
    paths:
      - public
    expire_in: 1 week
  only:
    - master
