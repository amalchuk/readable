daemon                                      off;
user                                        nginx;

worker_cpu_affinity                         auto;
worker_processes                            auto;
worker_rlimit_nofile                        65535;

error_log                                   /dev/stderr crit;
pid                                         /var/run/nginx.pid;

events {
    accept_mutex                            on;
    multi_accept                            on;
    use                                     epoll;
    worker_connections                      8192;
}

http {
    include                                 /etc/nginx/mime.types;
    default_type                            application/octet-stream;

    access_log                              off;
    server_tokens                           off;

    # Limit the total size of the HTTP request body:
    client_max_body_size                    50M;

    client_body_timeout                     10s;
    keepalive_timeout                       30s;
    reset_timedout_connection               on;
    send_timeout                            5s;

    sendfile                                on;
    tcp_nopush                              on;

    gzip                                    on;
    gzip_comp_level                         5;
    gzip_proxied                            any;
    gzip_types                              application/javascript application/json application/xml text/css text/plain;

    open_file_cache                         max=10000 inactive=20s;
    open_file_cache_errors                  on;
    open_file_cache_min_uses                2;
    open_file_cache_valid                   30s;

    set_real_ip_from                        10.0.0.0/8;
    set_real_ip_from                        172.16.0.0/12;
    set_real_ip_from                        192.168.0.0/16;

    uwsgi_cache_key                         "$scheme://$cookie_access_token$remote_user$uri";
    uwsgi_cache_path                        /tmp/readable_cache levels=1:2 keys_zone=readable_cache:50M max_size=1G;

    upstream readable_service {
        least_conn;
        server                              readable:8000 fail_timeout=0s;
        server                              readable:8001 fail_timeout=0s;
        server                              readable:8002 fail_timeout=0s;
        server                              readable:8003 fail_timeout=0s;
        keepalive                           100;
    }

    server {
        listen                              80 default_server backlog=65535 deferred so_keepalive=on;

        location ^~ /media/ {
            alias                           /application/readable/resources/mediafiles/;
            expires                         max;

            allow                           10.0.0.0/8;
            allow                           172.16.0.0/12;
            allow                           192.168.0.0/16;
            deny                            all;
        }

        location ^~ /static/ {
            alias                           /application/readable/resources/staticfiles/;
            expires                         max;
        }

        location = /favicon.ico {
            alias                           /application/readable/resources/staticfiles/favicon.ico;
            expires                         max;
        }

        location / {
            include                         /etc/nginx/uwsgi_params;
            uwsgi_pass                      uwsgi://readable_service;

            uwsgi_ignore_client_abort       on;
            uwsgi_ignore_headers            Cache-Control Expires Set-Cookie;
            uwsgi_socket_keepalive          on;

            uwsgi_cache                     readable_cache;
            uwsgi_cache_background_update   on;
            uwsgi_cache_bypass              $http_pragma;
            uwsgi_cache_lock                on;
            uwsgi_cache_revalidate          on;
            uwsgi_cache_use_stale           updating;
            uwsgi_cache_valid               200 1s;
        }
    }
}
